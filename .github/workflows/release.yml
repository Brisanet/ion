name: 'ğŸš€ release'

on:
  release:
    types: [published]

jobs:
  release:
    name: ğŸš€ release
    runs-on: ubuntu-latest
    environment: prod

    permissions:
      contents: read
      id-token: write

    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Node 12 (build)
        uses: actions/setup-node@v4
        with:
          node-version: 20.19.6

      - name: ğŸ“š Install packages
        run: |
          mkdir -p dist/ion
          echo '{"name": "ion", "version": "0.0.0"}' > dist/ion/package.json
          npm ci

      - name: ğŸ—ï¸ Build
        run: npm run build ion

      - name: ğŸŸ¢ Node 24 (publish)
        uses: actions/setup-node@v4
        with:
          node-version: 24.x
          registry-url: https://registry.npmjs.org

      - name: ğŸš€ Publish
        run: npm publish --provenance --access public --tag v19-lts
        working-directory: dist/ion
        env:
          CI: true

      - name: ğŸ“¢ Send message to Google Chat
        run: |
          API_KEY="${{ secrets.GOOGLE_CHAT_API_KEY }}"
          TOKEN="${{ secrets.GOOGLE_CHAT_TOKEN }}"
          SPACE_ID="${{ secrets.SPACE_ID }}"
          MESSAGE="Ion - Nova versÃ£o ${{ github.event.release.tag_name }} disponÃ­vel!"

          curl -X POST \
            -H "Content-Type: application/json; charset=UTF-8" \
            -d "{\"text\": \"${MESSAGE}\"}" \
            "https://chat.googleapis.com/v1/spaces/${SPACE_ID}/messages?key=${API_KEY}&token=${TOKEN}"
