name: "ğŸš€ release"

on:
  release:
    types: [published]

jobs:
  release:
    name: ğŸš€ release
    runs-on: ubuntu-latest
    environment: prod

    permissions:
      contents: read
      id-token: write

    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Node 12 (build)
        uses: actions/setup-node@v4
        with:
          node-version: 12.22.1

      - name: ğŸ“š Install packages
        run: yarn install --frozen-lockfile

      - name: ğŸ—ï¸ Build
        run: yarn build

      - name: ğŸŸ¢ Node 20 (publish)
        uses: actions/setup-node@v4
        with:
          node-version: 20
          registry-url: https://registry.npmjs.org
          scope: "@brisanet"

      - name: ğŸš€ Publish
        run: npm publish --access public --provenance
        working-directory: dist/ion
        env:
          CI: true
          NODE_AUTH_TOKEN: ${{ secrets.NPM_AUTH_TOKEN }}

      - name: ğŸ“¢ Send message to Google Chat
        run: |
          API_KEY="${{ secrets.GOOGLE_CHAT_API_KEY }}"
          TOKEN="${{ secrets.GOOGLE_CHAT_TOKEN }}"
          SPACE_ID="${{ secrets.SPACE_ID }}"
          MESSAGE="Ion - Nova versÃ£o disponÃ­vel!"

          curl -X POST \
            -H "Content-Type: application/json; charset=UTF-8" \
            -d "{\"text\": \"${MESSAGE}\"}" \
            "https://chat.googleapis.com/v1/spaces/${SPACE_ID}/messages?key=${API_KEY}&token=${TOKEN}"
